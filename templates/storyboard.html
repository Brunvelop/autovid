{% include 'components/head.html' %}
<script>
    const storyboardData = {
        scenes: '',
        status: '',
        ttsStatus: '',
        videoStatus: '',

        async createImages() {
            const response = await fetch("{{ url_for('create_images', serie_name=serie_name, video_n=video_n) }}", {
                method: 'POST'
            });
            this.ttsStatus = await response.text();
        },

        async generateTTS() {
            const response = await fetch("{{ url_for('generate_tts', serie_name=serie_name, video_n=video_n) }}", {
                method: 'POST'
            });
            this.ttsStatus = await response.text();
        },

        async generateVideo() {
            const response = await fetch("{{ url_for('generate_video', serie_name=serie_name, video_n=video_n) }}", {
                method: 'POST'
            });
            this.videoStatus = await response.text();
        },

        async updateStatus(sceneIndex, value) {
            const response = await fetch(`/storyboard/update_image_status/{{ serie_name }}/{{ video_n }}/${sceneIndex}/${value}`, {
                method: 'POST'
            });
            this.status.images_completed[sceneIndex] = value;
        },

        async updateScene(sceneIndex, field, value) {
            await fetch(`/storyboard/update/{{ serie_name }}/{{ video_n }}/${sceneIndex}/${field}`, {
                method: 'POST',
                body: new URLSearchParams({[field]: value})
            });
        },

        async remakePrompt(sceneIndex) {
            const response = await fetch(`/remake_prompt/{{ serie_name }}/{{ video_n }}/${sceneIndex}`, {
                method: 'POST',
                body: new URLSearchParams({text: this.scenes[sceneIndex].text})
            });
            const updatedScene = await response.json();
            this.scenes[sceneIndex] = updatedScene;
        },

        async remakeImage(sceneIndex) {
            this.scenes[sceneIndex].loading = true;
            try {
                const response = await fetch(`/storyboard/remake_image/{{ serie_name }}/{{ video_n }}/${sceneIndex}`, {
                    method: 'POST',
                    body: new URLSearchParams({image_prompt: this.scenes[sceneIndex].image_prompt})
                });
                const newImage = await response.json();
                this.scenes[sceneIndex].image_url = newImage.url;
            } catch (error) {
                this.scenes[sceneIndex].error = error.message;
            }
            this.scenes[sceneIndex].loading = false;
        }
    }
</script>

<body class="bg-gray-100 p-4" x-data="storyboardData">
    {% include 'components/navbar.html' %}
    <!-- Header -->
    <div class="w-full mb-4 mt-16 flex flex-col items-center justify-center">
        <h1 class="text-2xl font-bold">STORYBOARD {{ serie_name }} {{ video_n }}</h1>
        <!-- Navigation -->
        <div class="flex gap-2 mt-2">
            <a href="{{ url_for('show_storyboard', serie_name=serie_name, video_n=video_n|int - 1) }}" class="text-blue-500 hover:underline">‚¨ÖÔ∏è</a>
            <a href="{{ url_for('show_storyboard', serie_name=serie_name, video_n=video_n|int + 1) }}" class="text-blue-500 hover:underline">‚û°Ô∏è</a>
            
            {% if not video_data.production_status.images_generated %}
            <button @click="generateImages" class="bg-blue-500 text-white px-3 py-1 rounded">
                Generate Images <!-- ---------------------------------------------------------------------------------------------------------------------------------------- -->
            </button>
            {% endif %}

            <button @click="generateTTS"class="bg-blue-500 text-white px-3 py-1 rounded">
                Generate TTS
            </button>
            
            <button @click="generateVideo" class="bg-blue-500 text-white px-3 py-1 rounded">
                Generate Video
            </button>
        </div>
    </div>
    <!-- Scenes Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <template x-for="(scene, index) in scenes" :key="index">
            <div class="bg-white p-4 rounded shadow">
                <!-- Status -->
                <div class="flex justify-between mb-2">
                    <div class="flex gap-2">
                        <button @click="updateStatus(index, false)" 
                                class="bg-red-500 text-white px-2 py-1 rounded text-sm">‚ùå</button>
                        <button @click="updateStatus(index, true)" 
                                class="bg-green-500 text-white px-2 py-1 rounded text-sm">‚úîÔ∏è</button>
                    </div>
                </div>

                <!-- Image -->
                <div class="mb-2">
                    <img :src="scene.image_url" class="w-full rounded">
                </div>

                <!-- Audio -->
                <audio controls class="w-full mb-2">
                    <source :src="scene.audio_url" type="audio/mpeg">
                </audio>

                <!-- Text Inputs -->
                <div class="mb-2">
                    <label class="block text-sm mb-1">Narration:</label>
                    <textarea 
                        x-model="scene.text"
                        @input.debounce.500ms="updateScene(index, 'text', $event.target.value)"
                        class="w-full h-24 p-2 border rounded"></textarea>
                </div>

                <div>
                    <label class="block text-sm mb-1">Image Prompt:</label>
                    <textarea 
                        x-model="scene.image_prompt"
                        @input.debounce.500ms="updateScene(index, 'image', $event.target.value)"
                        class="w-full h-32 p-2 border rounded"></textarea>
                    
                    <div class="flex gap-2 mt-2">
                        <button @click="remakePrompt(index)"
                                class="bg-blue-500 text-white px-3 py-1 rounded">‚úçÔ∏è</button>
                        <button @click="remakeImage(index)"
                                class="bg-blue-500 text-white px-3 py-1 rounded">üé®</button>
                    </div>

                    <div x-show="scene.loading" class="mt-2">Regenerating image...</div>
                    <div x-show="scene.error" x-text="scene.error" class="text-red-500"></div>
                </div>
            </div>
        </template>
    </div>
</body>
</html>
